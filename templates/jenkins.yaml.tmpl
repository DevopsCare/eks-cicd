#
# Copyright (c) 2020 Risk Focus Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

fullnameOverride: jenkins

controller:
  numExecutors: 8
  adminPassword: "${admin_password}"
  resources:
    requests:
      cpu: ${jenkins_cpu}
      memory: ${jenkins_memory}
  jenkinsAdminEmail: "${project_prefix} <${project_prefix}@${global_fqdn}>"
  jenkinsUrl: "https://jenkins.${namespace}.${project_prefix}.${global_fqdn}/"
  serviceAnnotations:
    fabric8.io/expose: "true"
    fabric8.io/ingress.annotations: "kubernetes.io/ingress.class: nginx\ncert-manager.io/cluster-issuer: letsencrypt-prod"

  installPlugins:
    - ace-editor:1.1
    - ansicolor:0.7.5
    - antisamy-markup-formatter:2.1
    - apache-httpcomponents-client-4-api:4.5.13-1.0
    - authentication-tokens:1.4
    - aws-credentials:1.29
    - aws-java-sdk:1.11.995
    - basic-branch-build-strategies:1.3.2
    - blueocean:1.24.6
    - blueocean-autofavorite:1.2.4
    - blueocean-bitbucket-pipeline:1.24.6
    - blueocean-commons:1.24.6
    - blueocean-config:1.24.6
    - blueocean-core-js:1.24.6
    - blueocean-dashboard:1.24.6
    - blueocean-display-url:2.4.1
    - blueocean-events:1.24.6
    - blueocean-git-pipeline:1.24.6
    - blueocean-github-pipeline:1.24.6
    - blueocean-i18n:1.24.6
    - blueocean-jira:1.24.6
    - blueocean-jwt:1.24.6
    - blueocean-personalization:1.24.6
    - blueocean-pipeline-api-impl:1.24.6
    - blueocean-pipeline-editor:1.24.6
    - blueocean-pipeline-scm-api:1.24.6
    - blueocean-rest:1.24.6
    - blueocean-rest-impl:1.24.6
    - blueocean-web:1.24.6
    - bouncycastle-api:2.20
    - branch-api:2.6.3
    - cloudbees-bitbucket-branch-source:2.9.8
    - cloudbees-folder:6.15
    - config-file-provider:3.7.2
    - configuration-as-code:1.47
    - configuration-as-code-groovy:1.1
    - copyartifact:1.46
    - credentials:2.3.18
    - credentials-binding:1.24
    - display-url-api:2.3.4
    - docker-commons:1.17
    - docker-workflow:1.26
    - durable-task:1.35
    - favorite:2.3.3
    - folder-properties:1.2.1
    - git:4.7.1
    - git-client:3.7.1
    - git-server:1.9
    - github:1.33.1
    - github-api:1.123
    - github-branch-source:2.10.2
    - gradle:1.36
    - greenballs:1.15.1
    - h2-api:1.4.199
    - handlebars:3.0.8
    - handy-uri-templates-2-api:2.1.8-1.0
    - htmlpublisher:1.25
    - http_request:1.8.27
    - jackson2-api:2.12.3
    - javadoc:1.6
    - jaxb:2.3.0.1
    - jenkins-design-language:1.24.6
    - jira:3.2.1
    - job-dsl:1.77
    - jquery-detached:1.2.1
    - jsch:0.1.55.2
    - junit:1.49
    - kubernetes:1.29.4
    - kubernetes-client-api:4.13.3-1
    - kubernetes-credentials:0.8.0
    - kubernetes-credentials-provider:0.18-1
    - ldap:2.6
    - lockable-resources:2.10
    - mailer:1.34
    - matrix-auth:2.6.6
    - matrix-project:1.18
    - maven-plugin:3.10
    - metrics:4.0.2.7
    - momentjs:1.1.1
    - oauth-credentials:0.4
    - pipeline-aws:1.43
    - pipeline-build-step:2.13
    - pipeline-graph-analysis:1.10
    - pipeline-input-step:2.12
    - pipeline-maven:3.10.0
    - pipeline-milestone-step:1.3.2
    - pipeline-model-api:1.8.4
    - pipeline-model-definition:1.8.4
    - pipeline-model-extensions:1.8.4
    - pipeline-rest-api:2.19
    - pipeline-stage-step:2.5
    - pipeline-stage-tags-metadata:1.8.4
    - pipeline-stage-view:2.19
    - pipeline-utility-steps:2.7.1
    - plain-credentials:1.7
    - pubsub-light:1.13
    - rebuild:1.32
    - resource-disposer:0.15
    - saml:2.0.3
    - scm-api:2.6.4
    - scm-filter-branch-pr:0.5.1
    - script-security:1.76
    - snakeyaml-api:1.27.0
    - sonar:2.13
    - sse-gateway:1.24
    - ssh-credentials:1.18.1
    - structs:1.22
    - testng-plugin:1.15
    - timestamper:1.12
    - token-macro:2.15
    - trilead-api:1.0.13
    - variant:1.4
    - workflow-aggregator:2.6
    - workflow-api:2.42
    - workflow-basic-steps:2.23
    - workflow-cps:2.90
    - workflow-cps-global-lib:2.18
    - workflow-durable-task-step:2.38
    - workflow-job:2.40
    - workflow-multibranch:2.23
    - workflow-scm-step:2.12
    - workflow-step-api:2.23
    - workflow-support:3.8
    - ws-cleanup:0.39
  initializeOnce: true
  enableRawHtmlMarkupFormatter: true
  scriptApproval:
    - "method groovy.json.JsonSlurperClassic parseText java.lang.String"
    - "new groovy.json.JsonSlurperClassic"
    - "method hudson.model.Item delete"
    - "method jenkins.model.Jenkins getItemByFullName java.lang.String"
    - "staticMethod jenkins.model.Jenkins getInstance"
    - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods reverse java.lang.Object[]"

  JCasC:
    defaultConfig: true
    securityRealm: |-
      local:
        allowsSignup: false
        enableCaptcha: false
        users:
        - id: "$${chart-admin-username}"
          name: "Jenkins Admin"
          password: "$${chart-admin-password}"
    authorizationStrategy: |-
      loggedInUsersCanDoAnything:
        allowAnonymousRead: false
    security:
      globalJobDslSecurityConfiguration:
        useScriptSecurity: false
    configScripts:
      general: |
        jenkins:
          globalNodeProperties:
            - envVars:
                env:
                  - key: "DOCKER_REGISTRY"
                    value: "${ecr_url}"
                  - key: "SKAFFOLD_DEFAULT_REPO"
                    value: "${ecr_url}/${project_prefix}"
                  - key: "GLOBAL_ENABLED_ENVIRONMENT_TYPE"
                    value: "K8 Namespace"
                  - key: "GLOBAL_FQDN"
                    value: "${global_fqdn}"
                  - key: "PROJECT_PREFIX"
                    value: "${project_prefix}"
                  - key: "AWS_REGION"
                    value: "${aws_region}"
                  - key: "AWS_DEFAULT_REGION"
                    value: "${aws_region}"
      groovy: |
        groovy:
        - script: >
            import com.cloudbees.hudson.plugins.folder.*;
            import jenkins.model.Jenkins;
            if (Jenkins.instance.getItem('Infrastructure') == null) {
              Jenkins.instance.createProject(Folder.class, 'Infrastructure');
            }
      jobs: |
        jobs:
        - script: >
            multibranchPipelineJob('Infrastructure/Create') {
              branchSources {
                git {
                  id = 'cad3-create-casc'
                  remote('${cadmium_repo}')
                  credentialsId('cadmium')
                  includes('master')
                }
              }
              factory {
                workflowBranchProjectFactory {
                  scriptPath('Jenkinsfile.create')
                }
              }
            }
        - script: >
            multibranchPipelineJob('Infrastructure/Destroy') {
              branchSources {
                git {
                  id = 'cad3-destroy-casc'
                  remote('${cadmium_repo}')
                  credentialsId('cadmium')
                  includes('master')
                }
              }
              factory {
                workflowBranchProjectFactory {
                  scriptPath('Jenkinsfile.destroy')
                }
              }
            }

      unclassified: |
        unclassified:
          gitHubPluginConfig:
            configs:
              - credentialsId: "github-token"
                name: "GitHub"
            hookUrl: "https://jenkins.${namespace}.${project_prefix}.${global_fqdn}/github-webhook/"

      security: |
        security:
          globalJobDslSecurityConfiguration:
            useScriptSecurity: false
  priorityClassName: system-cluster-critical

  prometheus:
    enabled: true

agent:
  enabled: true
  defaultsProviderTemplate: default
  volumes:
    - type: HostPath
      hostPath: /var/run/docker.sock
      mountPath: /var/run/docker.sock
    - type: Secret
      mountPath: /home/jenkins/.docker
      secretName: jenkins-docker-cfg
    - type: Secret
      mountPath: /root/.m2/
      secretName: jenkins-maven-settings
  envVars:
    - name: "DOCKER_CONFIG"
      value: "/home/jenkins/.docker/"
    - name: "GIT_AUTHOR_EMAIL"
      value: "cadmium@${global_fqdn}"
    - name: "GIT_AUTHOR_NAME"
      value: "cadmium"
    - name: "GIT_COMMITTER_EMAIL"
      value: "cadmium@${global_fqdn}"
    - name: "GIT_COMMITTER_NAME"
      value: "cadmium"
    - name: "XDG_CONFIG_HOME"
      value: "/home/jenkins/agent"
    - name: "HOME"
      value: "/home/jenkins/agent"
    - name: "MAVEN_OPTS"
      value: "-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"

  # Best reference is https://<jenkins_url>/configuration-as-code/reference#Cloud-kubernetes. The example below creates a python pod template.
  podTemplates:
    kubernetes: |
      - containers:
          - image: "alpine/helm:3.1.2"
            name: "helm"
            resourceLimitCpu: "500m"
            resourceLimitMemory: "512Mi"
            resourceRequestCpu: "100m"
            resourceRequestMemory: "256Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
          - image: "bitnami/kubectl:1.16"
            name: "kubectl"
            resourceLimitCpu: "500m"
            resourceLimitMemory: "256Mi"
            resourceRequestCpu: "100m"
            resourceRequestMemory: "128Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "kubernetes"
        serviceAccount: "jenkins"
    gradle: |
      - containers:
          - image: "gcr.io/jenkinsxio/builder-gradle:2.1.155-778"
            name: "gradle"
            resourceLimitCpu: "1"
            resourceLimitMemory: "1024Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "gradle"
        serviceAccount: "jenkins"
    jx-base: |
      - containers:
          - image: "gcr.io/jenkinsxio/builder-jx:2.1.155-778"
            name: "jx-base"
            resourceLimitCpu: "400m"
            resourceLimitMemory: "512Mi"
            resourceRequestCpu: "200m"
            resourceRequestMemory: "256Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "jx-base"
        serviceAccount: "jenkins"
    maven: |
      - containers:
          - image: "gcr.io/jenkinsxio/builder-maven:2.1.155-778"
            name: "maven"
            resourceLimitCpu: "1"
            resourceLimitMemory: "1024Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "maven"
        serviceAccount: "jenkins"
    maven-java11: |
      - containers:
          - image: "gcr.io/jenkinsxio/builder-maven-java11:2.1.155-778"
            name: "maven"
            resourceLimitCpu: "1"
            resourceLimitMemory: "1024Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "maven-java11"
        serviceAccount: "jenkins"
    packer: |
      - containers:
          - image: "hashicorp/packer:1.5.5"
            name: "packer"
            resourceRequestCpu: "100m"
            resourceRequestMemory: "128Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "packer"
        serviceAccount: "jenkins"
    promote: |
      - containers:
          - image: "gcr.io/jenkinsxio/builder-jx:2.1.155-778"
            name: "promote"
            resourceLimitCpu: "400m"
            resourceLimitMemory: "200Mi"
            resourceRequestCpu: "200m"
            resourceRequestMemory: "100Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "promote"
        serviceAccount: "jenkins"
    python: |
      - containers:
          - image: "python:3-buster"
            name: "python"
            resourceLimitCpu: "2"
            resourceLimitMemory: "2048Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "python"
        serviceAccount: "jenkins"
    python2: |
      - containers:
          - image: "python:2-buster"
            name: "python"
            resourceLimitCpu: "2"
            resourceLimitMemory: "2048Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "python2"
        serviceAccount: "jenkins"
    terraform: |
      - containers:
          - image: "hashicorp/terraform:0.12.24"
            name: "terraform"
            resourceLimitCpu: "1"
            resourceLimitMemory: "1448Mi"
            resourceRequestCpu: "400m"
            resourceRequestMemory: "600Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "terraform"
        serviceAccount: "jenkins"
    helm3: |
      - containers:
          - image: "alpine/helm:3.1.2"
            name: "helm"
            resourceLimitCpu: "1"
            resourceLimitMemory: "1024Mi"
            resourceRequestCpu: "200m"
            resourceRequestMemory: "512Mi"
            runAsUser: 0
            runAsGroup: 1000
            TTYEnabled: true
            args: "cat"
            command: "/bin/sh -c"
        name: "helm3"
        serviceAccount: "jenkins"

rbac:
  create: true
  readSecrets: true

serviceAccount:
  annotations:
    eks.amazonaws.com/role-arn: "${iam_role}"
